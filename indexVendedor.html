<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabLog v7.0 - Sistema Integrado</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0f172a; --secondary: #334155; --accent: #38bdf8;
            --bg: #f8fafc; --card-bg: #ffffff;
            --coral: #ff7f50; --amarelo: #fbbf24; --lilas: #c084fc; --bege: #fcd34d;
            --success: #22c55e; --danger: #ef4444; --warning: #f59e0b; --money: #10b981;
        }

        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg); height: 100vh; display: flex; overflow: hidden; color: #1e293b; }
        
        /* --- SIDEBAR --- */
        aside { 
            width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; 
            transition: all 0.3s ease; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 10;
        }
        aside.hidden { margin-left: -260px; }
        .brand { padding: 30px; font-size: 1.5rem; font-weight: 800; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand span { color: var(--accent); }
        nav { padding: 20px 10px; flex: 1; overflow-y: auto; }
        nav button { 
            width: 100%; padding: 14px 18px; margin-bottom: 8px; background: transparent; border: none; 
            color: #94a3b8; text-align: left; cursor: pointer; border-radius: 8px; font-weight: 600; 
            display: flex; align-items: center; gap: 12px; transition: 0.2s; 
        }
        nav button:hover { background: rgba(255,255,255,0.05); color: #fff; }
        nav button.active { background: var(--accent); color: #0f172a; box-shadow: 0 0 15px rgba(56, 189, 248, 0.3); }

        /* --- MAIN --- */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        header { background: #fff; padding: 15px 30px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .view { display: none; padding: 30px; overflow-y: auto; height: 100%; box-sizing: border-box; }
        .view.active { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI ELEMENTS --- */
        .card { background: var(--card-bg); border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #e2e8f0; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        input:focus { border-color: var(--accent); outline: none; ring: 2px solid var(--accent); }
        
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn:hover { filter: brightness(110%); transform: translateY(-1px); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: #0f172a; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }

        /* --- MONITOR TEL√ÉO --- */
        #v-monitor { padding: 0 !important; background: #000; color: #fff; }
        .monitor-layout { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: background 1s; position: relative; }
        
        /* Painel Lateral do Monitor */
        .monitor-side-panel {
            position: absolute; top: 30px; right: 30px;
            background: rgba(0, 0, 0, 0.6); padding: 20px; border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3); text-align: left;
            backdrop-filter: blur(5px); min-width: 200px;
        }
        .monitor-side-item {
            color: #fff; font-size: 1.1rem; margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px; font-weight: bold;
        }
        .color-dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid #fff; }
        
        /* Timer Gigante */
        .timer-big { font-size: 7vw; font-family: 'Courier New', monospace; font-weight: 900; background: rgba(0,0,0,0.3); padding: 0 40px; border-radius: 20px; backdrop-filter: blur(5px); border: 4px solid rgba(255,255,255,0.2); transition: 0.3s; }
        
        /* Alerta Piscante */
        .timer-blink-red {
            animation: blinkRed 1s infinite;
            background-color: #ef4444 !important; color: #fff !important; border-color: #fff !important;
            box-shadow: 0 0 30px #ef4444;
        }
        @keyframes blinkRed { 50% { opacity: 0.5; } }

        /* --- ADMIN ROTAS --- */
        .admin-route-row { display: grid; grid-template-columns: 2fr 0.5fr 0.5fr 1fr 1fr 0.5fr; gap: 10px; margin-bottom: 10px; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .admin-route-row input { margin: 0; padding: 8px; font-size: 0.9rem; }
        .admin-route-header { font-weight: bold; font-size: 0.8rem; text-transform: uppercase; color: #64748b; margin-bottom: 5px; }

        /* --- EXPEDI√á√ÉO PRO --- */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { padding: 8px 16px; border: 1px solid #cbd5e1; background: #fff; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 0.9rem; white-space: nowrap; transition: 0.2s; }
        .filter-btn.active { background: var(--primary); color: #fff; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; border: 2px dashed #cbd5e1; border-radius: 8px; min-height: 50px; background: #f8fafc; align-items: center; margin-bottom: 15px; }
        .tag-chip { background: #0f172a; color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .tag-remove { cursor: pointer; color: var(--accent); }
        .exp-card { background: #fff; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 15px; display: flex; overflow: hidden; transition: 0.3s; }
        .exp-strip { width: 8px; }
        .exp-content { padding: 15px; flex: 1; display: flex; justify-content: space-between; align-items: center; }

        /* Login */
        #login-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 350px; text-align: center; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h1 style="color:var(--primary)">LabLog <span style="color:var(--accent)">7.0</span></h1>
            <p style="color:#64748b; margin-bottom:20px">Sistema Integrado</p>
            <select id="user-role">
                <option value="admin">üëë ADMIN / GER√äNCIA</option>
                <option value="vendas">üíº VENDEDOR / COMERCIAL</option>
                <option value="atend">‚òéÔ∏è ATENDIMENTO</option>
                <option value="exped">üì¶ EXPEDI√á√ÉO</option>
                <option value="reqs">üîß SETORES (REQ. INTERNA)</option>
                <option value="telao">üì∫ MONITOR (TEL√ÉO)</option>
            </select>
            <button class="btn btn-primary" style="width:100%; margin-top:15px" onclick="app.login()">ACESSAR</button>
        </div>
    </div>

    <aside id="sidebar">
        <div class="brand"><i class="fas fa-atom"></i> LAB<span>LOG</span></div>
        <nav id="menu-nav"></nav>
    </aside>

    <main>
        <header id="top-bar">
            <h3 id="page-title">Dashboard</h3>
            <div style="font-size:0.9rem; color:#64748b">
                <i class="far fa-user-circle"></i> <span id="user-display">Usu√°rio</span>
            </div>
        </header>

        <div id="v-vendas" class="view">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                <h2><i class="fas fa-chart-bar"></i> Gest√£o Comercial</h2>
                <div class="upload-zone" onclick="document.getElementById('file-sales').click()" style="padding: 10px 20px; border: 1px dashed var(--primary); border-radius:8px; cursor:pointer;">
                    <i class="fas fa-upload"></i> Importar CSV Vendas
                    <input type="file" id="file-sales" hidden onchange="app.importCSV('sales', this)">
                </div>
            </div>
            <div class="grid-4">
                <div class="card" style="border-left:5px solid var(--money)">
                    <div style="color:#64748b; font-size:0.9rem">FATURAMENTO</div>
                    <div id="kpi-fat" style="font-size:2rem; font-weight:800; color:#0f172a">R$ 0,00</div>
                </div>
                <div class="card" style="border-left:5px solid var(--accent)">
                    <div style="color:#64748b; font-size:0.9rem">TICKET M√âDIO</div>
                    <div id="kpi-ticket" style="font-size:2rem; font-weight:800; color:#0f172a">R$ 0,00</div>
                </div>
            </div>
            <div class="card">
                <h3>üèÜ Produtos Mais Vendidos</h3>
                <div id="rank-products"><p style="color:#aaa">Importe dados para ver o ranking.</p></div>
            </div>
        </div>

        <div id="v-monitor" class="view">
            <div id="monitor-bg" class="monitor-layout">
                
                <div class="monitor-side-panel">
                    <h3 style="margin:0 0 15px 0; color:#fff; border-bottom:1px solid #fff; padding-bottom:5px">GRADE HOR√ÅRIA</h3>
                    <div id="monitor-schedule-list"></div>
                </div>

                <div style="font-size: 1.5vw; font-weight: 900; letter-spacing: 5px; opacity: 0.8;">ROTA ATUAL</div>
                <div id="monitor-rota" style="font-size: 8vw; font-weight: 900; line-height: 1; text-transform: uppercase; text-shadow: 2px 2px 10px rgba(0,0,0,0.5);">---</div>
                
                <div id="monitor-timer" class="timer-big">00:00:00</div>
                
                <div style="margin-top: 30px; background: rgba(0,0,0,0.4); padding: 15px 30px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.3);">
                    <i class="fas fa-comment-alt" style="color:var(--accent)"></i> <span id="monitor-feed" style="font-style:italic; font-weight:bold">Carregando elogios...</span>
                </div>
            </div>
        </div>

        <div id="v-admin" class="view">
            <div class="card">
                <h2><i class="fas fa-cogs"></i> Configura√ß√£o de Rotas</h2>
                <div class="admin-route-row admin-route-header">
                    <div>Nome da Rota</div><div>Cor 1</div><div>Cor 2</div><div>In√≠cio</div><div>Fim</div><div>A√ß√£o</div>
                </div>
                <div id="admin-routes-list"></div>
                <button class="btn btn-success" style="margin-top:15px" onclick="app.addRouteRow()">+ Nova Rota</button>
                <button class="btn btn-primary" style="margin-top:15px; margin-left:10px" onclick="app.saveRoutesAdmin()">üíæ Salvar Altera√ß√µes</button>
            </div>
            <div class="card">
                <h3>Importa√ß√£o de Dados</h3>
                <div class="grid-3" style="margin-top:20px">
                    <div class="upload-zone" onclick="document.getElementById('file-clients').click()" style="text-align:center; padding:30px; border:2px dashed #ccc; border-radius:10px; cursor:pointer">
                        <i class="fas fa-users fa-3x"></i><br><b>Clientes</b>
                        <input type="file" id="file-clients" hidden onchange="app.importCSV('clients', this)">
                    </div>
                </div>
            </div>
        </div>

        <div id="v-reqs" class="view">
            <div class="card">
                <h2><i class="fas fa-clipboard-list"></i> Requisi√ß√£o Interna</h2>
                <div class="grid-3">
                    <select id="req-sector"><option>Montagem</option><option>Surfa√ßagem</option><option>Adm</option></select>
                    <select id="req-type"><option>RH (Pessoal)</option><option>Insumos</option><option>Manuten√ß√£o</option></select>
                    <select id="req-urgency"><option>Normal</option><option>Urgente</option></select>
                </div>
                <textarea id="req-desc" placeholder="Descreva sua necessidade..."></textarea>
                <button class="btn btn-primary" onclick="app.addReq()">ABRIR CHAMADO</button>
            </div>
            <h3>Meus Chamados</h3>
            <div id="req-list"></div>
        </div>

        <div id="v-atend" class="view">
            <div class="card">
                <h2><i class="fas fa-headset"></i> Nova Solicita√ß√£o</h2>
                <div class="grid-3">
                    <div>
                        <label>Cliente:</label>
                        <input type="text" id="at-cod" placeholder="Buscar..." oninput="app.searchCli(this.value)">
                        <small id="at-match" style="color:var(--success); font-weight:bold"></small>
                    </div>
                    <div>
                        <label>Tipo:</label>
                        <select id="at-type"><option>Coleta</option><option>Elogio</option><option>Reclamacao</option></select>
                    </div>
                </div>
                <textarea id="at-obs" placeholder="Detalhes..."></textarea>
                <button class="btn btn-accent" style="width:100%" onclick="app.addOrder()">ENVIAR</button>
            </div>
        </div>

        <div id="v-exped" class="view">
            <div class="filter-bar">
                <button class="filter-btn active" onclick="app.filterExped('TODOS', this)">TODOS</button>
                <button class="filter-btn" onclick="app.filterExped('AMARELO', this)">üü° AMARELO</button>
                <button class="filter-btn" onclick="app.filterExped('CORAL', this)">üü† CORAL</button>
                <button class="filter-btn" onclick="app.filterExped('BEGE', this)">üü§ BEGE</button>
                <button class="filter-btn" onclick="app.filterExped('ROSA', this)">üü£ ROSA</button>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                    <h3><i class="fas fa-barcode"></i> Montagem de Lote</h3>
                    <button class="btn btn-success" onclick="app.printLote()"><i class="fas fa-print"></i> Imprimir Lote</button>
                </div>
                <div class="tag-container" id="tag-area" onclick="document.getElementById('exp-input').focus()">
                    <input type="text" id="exp-input" placeholder="Bipe o ID e Enter..." style="border:none; background:transparent; outline:none; flex:1; min-width:150px;" onkeydown="app.handleTagInput(event)">
                </div>
            </div>
            <h3>Pedidos Pendentes</h3>
            <div id="exped-list"></div>
        </div>

        <div id="v-perdas" class="view">
            <div class="card">
                <h2><i class="fas fa-chart-pie"></i> Finan√ßas e Perdas</h2>
                <div class="grid-3">
                    <input type="text" id="loss-item" placeholder="Item">
                    <select id="loss-reason"><option>Quebra</option><option>Erro Humano</option></select>
                    <input type="number" id="loss-val" placeholder="Valor R$">
                </div>
                <button class="btn btn-danger" onclick="app.addLoss()">REGISTRAR</button>
            </div>
            <div class="card">
                <h3>Preju√≠zo Total: <span id="loss-total" style="color:var(--danger)">R$ 0,00</span></h3>
                <ul id="loss-history"></ul>
            </div>
        </div>

    </main>

<script>
const app = {
    data: {
        clients: [{ id: "712", name: "Strike √ìticas", route: "BEGE" }, { id: "101", name: "Vis√£o Total", route: "AMARELO" }],
        orders: [], reqs: [], losses: [], feedbacks: [],
        salesHistory: [ { prod: "Lente VS", val: 150, cli: "Strike" } ],
        tags: [], filter: 'TODOS',
        routes: [
            { name: "CORAL / LIL√ÅS", c1: "#ff7f50", c2: "#dcd0ff", s: "16:15:01", e: "09:00:00" },
            { name: "AMARELO", c1: "#fcd34d", c2: "#fcd34d", s: "09:00:01", e: "10:00:00" },
            { name: "BEGE / LIL√ÅS", c1: "#fcd34d", c2: "#dcd0ff", s: "10:00:01", e: "14:00:00" },
            { name: "ROSA / AMARELO", c1: "#f472b6", c2: "#fcd34d", s: "14:00:01", e: "16:15:00" }
        ]
    },

    init: function() {
        const saved = localStorage.getItem('lablog_v7');
        if(saved) this.data = { ...this.data, ...JSON.parse(saved) };
        setInterval(() => this.monitorLoop(), 1000);
        setInterval(() => this.feedLoop(), 8000);
        setInterval(() => this.updateTimers(), 1000);
        this.renderTags(); this.renderExped();
    },

    save: function() { localStorage.setItem('lablog_v7', JSON.stringify(this.data)); },

    login: function() {
        const role = document.getElementById('user-role').value;
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('user-display').innerText = role.toUpperCase();
        
        const menu = document.getElementById('menu-nav');
        const sidebar = document.getElementById('sidebar');
        const topbar = document.getElementById('top-bar');

        if(role === 'telao') {
            sidebar.classList.add('hidden'); topbar.style.display = 'none';
            this.nav('monitor');
            if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
        } else {
            let html = `<button onclick="app.nav('monitor')"><i class="fas fa-tv"></i> Tel√£o</button>`;
            if(role === 'admin' || role === 'vendas') html += `<button onclick="app.nav('vendas')"><i class="fas fa-chart-bar"></i> Vendas</button>`;
            if(role === 'admin') html += `<button onclick="app.nav('admin')"><i class="fas fa-cogs"></i> Admin</button>`;
            if(role === 'admin' || role === 'reqs') html += `<button onclick="app.nav('reqs')"><i class="fas fa-clipboard"></i> Requisi√ß√µes</button>`;
            if(role === 'admin' || role === 'atend') html += `<button onclick="app.nav('atend')"><i class="fas fa-headset"></i> Atendimento</button>`;
            if(role === 'admin' || role === 'exped') html += `<button onclick="app.nav('exped')"><i class="fas fa-truck"></i> Expedi√ß√£o</button>`;
            if(role === 'admin') html += `<button onclick="app.nav('perdas')"><i class="fas fa-chart-line"></i> Perdas</button>`;
            
            menu.innerHTML = html;
            this.nav(role === 'admin' ? 'admin' : 'exped');
        }
    },

    nav: function(view) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.getElementById('v-'+view).classList.add('active');
        document.getElementById('page-title').innerText = view.toUpperCase();
        if(view === 'vendas') this.renderSalesDashboard();
        if(view === 'perdas') this.renderLosses();
        if(view === 'reqs') this.renderReqs();
        if(view === 'admin') this.renderAdminRoutes();
    },

    // --- ADMIN ROTAS ---
    renderAdminRoutes: function() {
        const container = document.getElementById('admin-routes-list');
        container.innerHTML = this.data.routes.map((r, i) => `
            <div class="admin-route-row">
                <input type="text" value="${r.name}" id="r-name-${i}">
                <input type="color" value="${r.c1}" id="r-c1-${i}">
                <input type="color" value="${r.c2}" id="r-c2-${i}">
                <input type="text" value="${r.s}" id="r-s-${i}" placeholder="HH:MM:SS">
                <input type="text" value="${r.e}" id="r-e-${i}" placeholder="HH:MM:SS">
                <button class="btn btn-danger" style="padding:5px 10px" onclick="app.removeRoute(${i})"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
    },
    addRouteRow: function() { this.data.routes.push({ name: "NOVA ROTA", c1: "#000000", c2: "#ffffff", s: "00:00:00", e: "00:00:00" }); this.renderAdminRoutes(); },
    removeRoute: function(index) { if(confirm("Remover?")){ this.data.routes.splice(index, 1); this.renderAdminRoutes(); } },
    saveRoutesAdmin: function() {
        this.data.routes.forEach((r, i) => {
            r.name = document.getElementById(`r-name-${i}`).value;
            r.c1 = document.getElementById(`r-c1-${i}`).value;
            r.c2 = document.getElementById(`r-c2-${i}`).value;
            r.s = document.getElementById(`r-s-${i}`).value;
            r.e = document.getElementById(`r-e-${i}`).value;
        });
        this.save(); alert("Rotas atualizadas!");
        document.getElementById('monitor-schedule-list').innerHTML = ''; // For√ßa update do tel√£o
    },

    // --- MONITOR ENGINE ---
    monitorLoop: function() {
        const now = new Date();
        const sec = (now.getHours()*3600) + (now.getMinutes()*60) + now.getSeconds();
        
        // Renderiza lista lateral se vazia
        const listEl = document.getElementById('monitor-schedule-list');
        if(listEl.innerHTML === '') {
            listEl.innerHTML = this.data.routes.map(r => `<div class="monitor-side-item"><div class="color-dot" style="background:${r.c1}"></div><span>${r.name}</span><span style="font-size:0.9rem;opacity:0.8;margin-left:auto">${r.e.substring(0,5)}</span></div>`).join('');
        }

        const active = this.data.routes.find(r => {
            const s = this.hms(r.s), e = this.hms(r.e);
            return s > e ? (sec >= s || sec <= e) : (sec >= s && sec <= e);
        });

        if(active) {
            document.getElementById('monitor-bg').style.background = `linear-gradient(135deg, ${active.c1}, ${active.c2})`;
            document.getElementById('monitor-rota').innerText = active.name;
            const e = this.hms(active.e); let t = new Date(); t.setHours(Math.floor(e/3600), Math.floor((e%3600)/60), e%60, 0);
            if(t < now) t.setDate(t.getDate()+1);
            const diff = t - now;
            const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
            const timerDiv = document.getElementById('monitor-timer');
            timerDiv.innerText = `${this.pad(h)}:${this.pad(m)}:${this.pad(s)}`;
            if(diff <= 900000) timerDiv.classList.add('timer-blink-red'); else timerDiv.classList.remove('timer-blink-red');
        }
    },

    // --- OUTROS M√ìDULOS (Mantidos) ---
    renderSalesDashboard: function() {
        const totalFat = this.data.salesHistory.reduce((a,b) => a + b.val, 0);
        const totalVol = this.data.salesHistory.length;
        document.getElementById('kpi-fat').innerText = "R$ " + totalFat.toFixed(2);
        document.getElementById('kpi-ticket').innerText = "R$ " + (totalVol ? (totalFat / totalVol) : 0).toFixed(2);
        const counts = {}; this.data.salesHistory.forEach(s => { counts[s.prod] = (counts[s.prod] || 0) + 1; });
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
        document.getElementById('rank-products').innerHTML = sorted.map((p, i) => `<div class="product-rank-item" style="padding:10px;border-bottom:1px solid #eee"><b>${i+1}. ${p[0]}</b> - ${p[1]} un.</div>`).join('');
    },
    
    // ... Fun√ß√µes de Expedi√ß√£o, Perdas, Reqs e Atendimento (Id√™nticas √† v6, apenas compactadas para caber) ...
    handleTagInput: function(e) { if(e.key==='Enter'||e.key===','||e.key===' '){e.preventDefault(); const v=e.target.value.trim().toUpperCase(); if(v&&!this.data.tags.includes(v)){this.data.tags.push(v); this.renderTags(); const o=this.data.orders.find(o=>o.id===v); if(o){o.sel=true; this.save(); this.renderExped();}} e.target.value="";} if(e.key==='Backspace'&&e.target.value===""&&this.data.tags.length>0){this.data.tags.pop(); this.renderTags();} },
    removeTag: function(tag) { this.data.tags=this.data.tags.filter(t=>t!==tag); this.renderTags(); const o=this.data.orders.find(o=>o.id===tag); if(o){o.sel=false; this.save(); this.renderExped();} },
    renderTags: function() { const area=document.getElementById('tag-area'), inp=document.getElementById('exp-input'); area.innerHTML=''; this.data.tags.forEach(t=>{const el=document.createElement('div'); el.className='tag-chip'; el.innerHTML=`${t} <span class="tag-remove" onclick="app.removeTag('${t}')">√ó</span>`; area.appendChild(el);}); area.appendChild(inp); inp.focus(); },
    filterExped: function(f, b) { this.data.filter=f; document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); this.renderExped(); },
    renderExped: function() { const l=document.getElementById('exped-list'); const f=this.data.orders.filter(o => this.data.filter==='TODOS' || o.route.includes(this.data.filter)); l.innerHTML=f.map(o=>`<div class="exp-card"><div class="exp-strip" style="background:${this.getRouteColor(o.route)}"></div><div class="exp-content"><div><h4>${o.cli} <small>(${o.id})</small></h4><span style="background:#eee;padding:2px 6px;border-radius:4px;font-size:0.8rem">${o.route}</span></div><div style="text-align:right"><div class="exp-timer" data-time="${o.time}">...</div><input type="checkbox" ${o.sel?'checked':''} disabled style="margin-top:5px"><button onclick="app.finishOrd('${o.id}')" style="margin-left:10px;cursor:pointer;border:none;background:none;color:green"><i class="fas fa-check-circle"></i></button></div></div></div>`).join('') || '<div style="text-align:center;color:#999;margin-top:20px">Vazio</div>'; this.updateTimers(); },
    updateTimers: function() { document.querySelectorAll('.exp-timer').forEach(el=>{const d=Date.now()-parseInt(el.getAttribute('data-time')); const h=Math.floor(d/3600000), m=Math.floor((d%3600000)/60000), s=Math.floor((d%60000)/1000); el.innerText=`${h}h ${m}m ${s}s`; if(d>172800000)el.classList.add('late');else el.classList.remove('late');}); },
    getRouteColor: function(r) { if(r.includes('AMARELO')) return '#fbbf24'; if(r.includes('CORAL')) return '#ff7f50'; if(r.includes('BEGE')) return '#fcd34d'; if(r.includes('ROSA')) return '#c084fc'; return '#ccc'; },
    finishOrd: function(id) { if(confirm("Baixar?")){this.data.orders=this.data.orders.filter(o=>o.id!==id); this.save(); this.renderExped();} },
    printLote: function() { if(!this.data.tags.length)return alert("Bipe!"); alert("Imprimindo: "+this.data.tags.join(", ")); },
    addReq: function() { const s=document.getElementById('req-sector').value, t=document.getElementById('req-type').value, d=document.getElementById('req-desc').value; if(!d)return; this.data.reqs.push({id:"R"+Date.now(),s,t,d,time:Date.now()}); this.save(); this.renderReqs(); document.getElementById('req-desc').value=""; },
    renderReqs: function() { document.getElementById('req-list').innerHTML=this.data.reqs.map(r=>`<div class="ticket-card"><div><h4>${r.t}-${r.s}</h4><p>${r.d}</p></div><button class="btn btn-success" onclick="app.finishReq('${r.id}')">OK</button></div>`).join(''); },
    finishReq: function(id) { this.data.reqs=this.data.reqs.filter(r=>r.id!==id); this.save(); this.renderReqs(); },
    searchCli: function(v) { const c=this.data.clients.find(x=>x.id===v||x.name.toLowerCase().includes(v.toLowerCase())); document.getElementById('at-match').innerText=c?c.name:""; },
    addOrder: function() { const v=document.getElementById('at-cod').value, c=this.data.clients.find(x=>x.id===v||x.name.toLowerCase().includes(v.toLowerCase())); const t=document.getElementById('at-type').value, o=document.getElementById('at-obs').value; if(!c && t!=='Elogio' && t!=='Reclamacao') return alert("Cliente inv√°lido"); if(t==='Elogio'||t==='Reclamacao'){ this.data.feedbacks.unshift({msg:o,type:t,from:c?c.name:'Anonimo'}); alert('Feedback enviado!'); } else { this.data.orders.push({id:"P"+Date.now().toString().slice(-
