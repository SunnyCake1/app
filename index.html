<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabLog v9.2 - Full Mobile</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0f172a; --secondary: #334155; --accent: #38bdf8;
            --bg: #f8fafc; --card-bg: #ffffff;
            --success: #22c55e; --danger: #ef4444; --warning: #f59e0b; --money: #10b981;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); height: 100vh; display: flex; overflow: hidden; color: #1e293b; }
        
        /* LAYOUT & SIDEBAR */
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; transition: 0.3s; z-index: 100; height: 100%; }
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; transition: 0.3s; }
        
        header { background: #fff; padding: 15px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; height: 60px; box-sizing: border-box; }
        #mobile-btn { display: none; background: none; border: none; font-size: 1.5rem; color: var(--primary); cursor: pointer; }

        .brand { padding: 30px; font-size: 1.5rem; font-weight: 800; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand span { color: var(--accent); }
        nav { padding: 20px 10px; flex: 1; overflow-y: auto; }
        nav button { width: 100%; padding: 14px; margin-bottom: 8px; background: transparent; border: none; color: #94a3b8; text-align: left; cursor: pointer; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        nav button:hover, nav button.active { background: var(--accent); color: #0f172a; }

        /* VIEWS & CARDS */
        .view { display: none; padding: 20px; overflow-y: auto; height: 100%; box-sizing: border-box; padding-bottom: 80px; }
        .view.active { display: block; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #e2e8f0; }
        
        /* FORMS */
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #000; }

        /* MONITOR */
        #v-monitor { padding: 0 !important; background: #000; color: #fff; }
        .monitor-layout { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .monitor-side-panel { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; backdrop-filter: blur(5px); text-align: left; }
        .timer-big { font-size: 8vw; font-family: monospace; font-weight: 900; background: rgba(0,0,0,0.5); padding: 10px 30px; border-radius: 15px; border: 2px solid #fff; margin-top: 10px; }
        .timer-blink-red { animation: blink 1s infinite; background: #ef4444 !important; border-color: #ef4444 !important; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* EXPEDI√á√ÉO */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { padding: 8px 16px; border: 1px solid #cbd5e1; background: #fff; border-radius: 20px; white-space: nowrap; cursor: pointer; }
        .filter-btn.active { background: var(--primary); color: #fff; }
        .exp-card { background: #fff; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 10px; display: flex; overflow: hidden; }
        .exp-strip { width: 10px; }
        .exp-content { padding: 15px; flex: 1; display: flex; justify-content: space-between; align-items: center; }
        .tag-chip { background: #0f172a; color: #fff; padding: 5px 10px; border-radius: 15px; display: inline-flex; align-items: center; gap: 5px; margin: 2px; font-size: 0.8rem; }

        /* ADMIN */
        .admin-route-row { display: grid; grid-template-columns: 2fr 0.5fr 0.5fr 1fr 1fr 0.5fr; gap: 5px; align-items: center; padding: 10px; background: #f8fafc; border: 1px solid #eee; margin-bottom: 5px; border-radius: 8px; }

        /* CRM */
        .kpi-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .kpi-card { flex: 1; background: #f1f5f9; padding: 10px; border-radius: 8px; text-align: center; border-top: 3px solid #ccc; }
        .suggestion-box { background: #ecfdf5; border: 1px solid #6ee7b7; color: #065f46; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            aside { position: fixed; left: -260px; height: 100%; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
            aside.active { left: 0; }
            #mobile-btn { display: block; }
            
            #monitor-rota { font-size: 15vw !important; line-height: 1.1; }
            .timer-big { font-size: 18vw; padding: 5px 15px; width: 80%; }
            .monitor-side-panel { position: relative; top: auto; right: auto; width: 90%; margin-bottom: 20px; }
            
            .admin-route-row { display: flex; flex-direction: column; border-left: 5px solid var(--primary); }
            .admin-route-header { display: none; }
        }

        /* --- ATUALIZE NO SEU CSS --- */
.admin-route-row { 
    display: grid; 
    /* Ajustei as colunas para caber o bot√£o de igualar e o preview */
    grid-template-columns: 1.5fr 0.5fr 0.2fr 0.5fr 1fr 1fr 0.5fr; 
    gap: 8px; 
    align-items: center; 
    padding: 12px; 
    background: #fff; 
    border: 1px solid #e2e8f0; 
    margin-bottom: 8px; 
    border-radius: 8px; 
    transition: 0.2s;
}

/* Barra de preview do gradiente */
.route-preview {
    height: 8px;
    border-radius: 4px;
    grid-column: 1 / -1; /* Ocupa a linha toda abaixo dos inputs */
    margin-top: 5px;
    border: 1px solid rgba(0,0,0,0.1);
}

/* Bot√£o pequeno de igualar cor */
.btn-mini {
    padding: 5px;
    background: #e2e8f0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    color: #64748b;
}
.btn-mini:hover { background: #cbd5e1; color: #000; }

/* No Mobile, ajustamos para ficar bonito */
@media (max-width: 768px) {
    .admin-route-row { 
        display: flex; 
        flex-direction: column; 
        gap: 10px;
        border-left: 5px solid var(--primary);
    }
    .route-preview { width: 100%; height: 15px; }
}

        /* LOGIN */
        #login-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h1 style="color:var(--primary)">LabLog <span style="color:var(--accent)">9.2</span></h1>
            <p style="color:#64748b">Sistema Completo</p>
            <select id="user-role">
                <option value="admin">üëë ADMIN / GER√äNCIA</option>
                <option value="vendas">üíº VENDEDOR</option>
                <option value="atend">‚òéÔ∏è ATENDIMENTO</option>
                <option value="exped">üì¶ EXPEDI√á√ÉO</option>
                <option value="telao">üì∫ MONITOR</option>
            </select>
            <button class="btn btn-primary" onclick="window.app.login()">ACESSAR</button>
        </div>
    </div>

    <aside id="sidebar">
        <div class="brand">LAB<span>LOG</span> <button onclick="window.app.toggleMenu()" style="float:right; background:none; border:none; color:#fff; display:none; font-size:2rem; line-height:0.5">√ó</button></div>
        <nav id="menu-nav"></nav>
        <div style="padding:20px;">
            <button onclick="window.app.logout()" style="background:rgba(255,255,255,0.1); border:none; color:#fff; width:100%; padding:10px; border-radius:6px;">Sair</button>
        </div>
    </aside>

    <main>
        <header id="top-bar">
            <div style="display:flex; align-items:center; gap:15px">
                <button id="mobile-btn" onclick="window.app.toggleMenu()"><i class="fas fa-bars"></i></button>
                <h3 id="page-title" style="margin:0">Dashboard</h3>
            </div>
            <div style="font-size:0.8rem; color:#64748b"><i class="far fa-user-circle"></i> <span id="user-display">User</span></div>
        </header>

        <div id="v-monitor" class="view">
            <div id="monitor-bg" class="monitor-layout">
                <div class="monitor-side-panel">
                    <h4 style="margin:0 0 10px 0; color:#fff; border-bottom:1px solid #fff;">PR√ìXIMAS ROTAS</h4>
                    <div id="monitor-schedule-list"></div>
                </div>
                <div style="font-size: 1rem; opacity: 0.8; margin-top:20px">ROTA ATUAL</div>
                <div id="monitor-rota" style="font-size: 6vw; font-weight: 900; text-transform: uppercase;">---</div>
                <div id="monitor-timer" class="timer-big">00:00:00</div>
                <div style="margin-top: 30px; background: rgba(0,0,0,0.4); padding: 10px 20px; border-radius: 50px;">
                    <i class="fas fa-comment-alt" style="color:var(--accent)"></i> <span id="monitor-feed">Sistema Online</span>
                </div>
            </div>
        </div>

        <div id="v-admin" class="view">
            <div class="card">
                <h3>Configura√ß√£o de Rotas</h3>
                <div class="admin-route-row admin-route-header">
                    <div>Nome</div>
                    <div>Cor 1</div>
                    <div></div> <div>Cor 2</div>
                    <div>In√≠cio</div>
                    <div>Fim</div>
                    <div>Del</div>
            </div>
                <div id="admin-routes-list"></div>
                <button class="btn btn-success" onclick="window.app.addRouteRow()">+ Rota</button>
                <button class="btn btn-primary" onclick="window.app.saveRoutesAdmin()">Salvar</button>
            </div>
            <div class="card">
                <h3>Importar Dados</h3>
                <div class="kpi-row">
                    <button class="btn btn-warning" onclick="document.getElementById('file-cli').click()">Clientes CSV</button>
                    <input type="file" id="file-cli" hidden onchange="window.app.importCSV('clients', this)">
                    <button class="btn btn-warning" onclick="document.getElementById('file-sales').click()">Vendas CSV</button>
                    <input type="file" id="file-sales" hidden onchange="window.app.importCSV('sales', this)">
                </div>
            </div>
        </div>

        <div id="v-vendas" class="view">
            <div class="card">
                <label>Cliente:</label>
                <select id="crm-select" onchange="window.app.loadClientCRM()" style="width:100%; padding:10px; font-size:1.1rem">
                    <option value="">-- Selecione --</option>
                </select>
            </div>

            <div id="crm-content" style="display:none">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <h2 id="crm-name" style="margin:0">Cliente</h2>
                        <span id="crm-route" style="background:#333; color:#fff; padding:3px 8px; border-radius:5px; font-size:0.8rem">ROTA</span>
                    </div>
                    <div class="kpi-row" style="margin-top:15px">
                        <div class="kpi-card" style="border-top-color:var(--money)"><small>FATURAMENTO</small><br><b id="kpi-fat">R$ 0</b></div>
                        <div class="kpi-card" style="border-top-color:var(--accent)"><small>TICKET</small><br><b id="kpi-ticket">R$ 0</b></div>
                    </div>
                    <div><canvas id="salesChart" style="max-height:200px"></canvas></div>
                    <div class="suggestion-box"><i class="fas fa-lightbulb"></i> <span id="crm-suggestion">...</span></div>
                </div>
                
                <div class="card">
                    <h3>Registrar Visita</h3>
                    <textarea id="visit-note" rows="3" placeholder="O que foi conversado?"></textarea>
                    <button class="btn btn-success" onclick="window.app.addVisit()">Salvar Visita</button>
                    <div id="visit-history" style="margin-top:15px; max-height:200px; overflow-y:auto"></div>
                </div>
            </div>
        </div>

        <div id="v-exped" class="view">
            <div class="filter-bar">
                <button class="filter-btn active" onclick="window.app.filterExped('TODOS', this)">TODOS</button>
                <button class="filter-btn" onclick="window.app.filterExped('AMARELO', this)">üü° AM</button>
                <button class="filter-btn" onclick="window.app.filterExped('CORAL', this)">üü† COR</button>
                <button class="filter-btn" onclick="window.app.filterExped('BEGE', this)">üü§ BEG</button>
            </div>
            <div class="card">
                <h3>Montagem de Lote</h3>
                <input type="text" id="exp-input" placeholder="Bipe o ID aqui..." onkeydown="window.app.handleTagInput(event)">
                <div id="tag-area" style="margin-top:10px; display:flex; flex-wrap:wrap"></div>
                <button class="btn btn-success" style="margin-top:10px" onclick="window.app.printLote()"><i class="fas fa-print"></i> Imprimir Lote</button>
            </div>
            <h3>Pendentes</h3>
            <div id="exped-list"></div>
        </div>

        <div id="v-reqs" class="view">
            <div class="card">
                <h3>Nova Requisi√ß√£o</h3>
                <select id="req-sector"><option>Montagem</option><option>Surfa√ßagem</option><option>Adm</option></select>
                <select id="req-type"><option>RH</option><option>Insumos</option><option>Manuten√ß√£o</option></select>
                <textarea id="req-desc" placeholder="Descreva..."></textarea>
                <button class="btn btn-primary" onclick="window.app.addReq()">Abrir Chamado</button>
            </div>
            <h3>Chamados Abertos</h3>
            <div id="req-list"></div>
        </div>

        <div id="v-atend" class="view">
            <div class="card">
                <h3>Solicita√ß√£o / Coleta</h3>
                <input type="text" id="at-cod" placeholder="Cliente..." oninput="window.app.searchCli(this.value)">
                <small id="at-match" style="color:var(--success)"></small>
                <select id="at-type"><option>Coleta</option><option>Elogio</option><option>Reclamacao</option></select>
                <textarea id="at-obs" placeholder="Obs..."></textarea>
                <button class="btn btn-accent" onclick="window.app.addOrder()">Enviar</button>
            </div>
        </div>

        <div id="v-perdas" class="view">
            <div class="card">
                <h3>Registrar Perda</h3>
                <input type="text" id="loss-item" placeholder="Item">
                <select id="loss-reason"><option>Quebra</option><option>Erro Humano</option></select>
                <input type="number" id="loss-val" placeholder="Valor R$">
                <button class="btn btn-danger" onclick="window.app.addLoss()">Registrar</button>
            </div>
            <div class="card">
                <h3>Total: <span id="loss-total" style="color:var(--danger)">R$ 0,00</span></h3>
                <ul id="loss-history"></ul>
            </div>
        </div>

    </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBwfvoHhg4mv-XJ7408z90GOtoIv2VjCq0",
  authDomain: "lablog-pro.firebaseapp.com",
  projectId: "lablog-pro",
  storageBucket: "lablog-pro.firebasestorage.app",
  messagingSenderId: "449442181804",
  appId: "1:449442181804:web:195ecea2b9941afb7aa509",
  measurementId: "G-6Q52LZ2NXP"
};

const firebaseApp = initializeApp(firebaseConfig);
const db = getFirestore(firebaseApp);
const auth = getAuth(firebaseApp);

const app = {
    data: { clients: [], salesHistory: [], routes: [], orders: [], reqs: [], losses: [], tags: [], filter: 'TODOS' },

    init: function() {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('user-display').innerText = user.email.split('@')[0];
                const savedRole = localStorage.getItem('userRole') || 'admin';
                this.renderMenu(savedRole);
                this.startRealtimeSync();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
            }
        });
        setInterval(() => this.monitorLoop(), 1000);
        setInterval(() => this.updateTimers(), 1000);
    },

    toggleMenu: function() { document.getElementById('sidebar').classList.toggle('active'); },

    login: async function() {
        const role = document.getElementById('user-role').value;
        const email = prompt("Email:");
        const pass = prompt("Senha:");
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            localStorage.setItem('userRole', role);
            this.renderMenu(role);
            this.nav(role === 'telao' ? 'monitor' : 'admin');
        } catch (e) { alert("Erro: " + e.message); }
    },

    logout: () => signOut(auth).then(()=>location.reload()),

    renderMenu: function(role) {
        const m = document.getElementById('menu-nav');
        let h = `<button onclick="window.app.nav('monitor')"><i class="fas fa-tv"></i> Tel√£o</button>`;
        if(role==='admin' || role==='vendas') h += `<button onclick="window.app.nav('vendas')"><i class="fas fa-briefcase"></i> Vendas</button>`;
        if(role==='admin') h += `<button onclick="window.app.nav('admin')"><i class="fas fa-cogs"></i> Admin</button>`;
        if(role==='admin' || role==='exped') h += `<button onclick="window.app.nav('exped')"><i class="fas fa-barcode"></i> Expedi√ß√£o</button>`;
        if(role==='admin' || role==='atend') h += `<button onclick="window.app.nav('atend')"><i class="fas fa-headset"></i> Atendimento</button>`;
        if(role==='admin' || role==='reqs') h += `<button onclick="window.app.nav('reqs')"><i class="fas fa-clipboard-list"></i> Requisi√ß√µes</button>`;
        if(role==='admin') h += `<button onclick="window.app.nav('perdas')"><i class="fas fa-chart-line"></i> Finan√ßas</button>`;
        m.innerHTML = h;
    },

    nav: function(v) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.getElementById('v-'+v).classList.add('active');
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('page-title').innerText = v.toUpperCase();
        if(v==='vendas') this.populateClientSelect();
        if(v==='admin') this.renderAdminRoutes();
        if(v==='reqs') this.renderReqs();
        if(v==='exped') this.renderExped();
        if(v==='perdas') this.renderLosses();
    },

    startRealtimeSync: function() {
        onSnapshot(doc(db, "config", "laboratorio"), (snap) => {
            if(snap.exists()) {
                this.data = { ...this.data, ...snap.data() };
                this.refreshCurrentView();
            } else { this.save(); }
        });
    },

    save: async function() { await setDoc(doc(db, "config", "laboratorio"), this.data); },

    refreshCurrentView: function() {
        const active = document.querySelector('.view.active');
        if(active) {
            const id = active.id.replace('v-','');
            if(id==='admin') this.renderAdminRoutes();
            if(id==='exped') this.renderExped();
            if(id==='reqs') this.renderReqs();
            if(id==='perdas') this.renderLosses();
        }
    },

    // --- ADMIN ---
    // --- ADMIN ROTAS (ATUALIZADA) ---
    renderAdminRoutes: function() {
        const div = document.getElementById('admin-routes-list');
        if(!div) return;
        
        // Cabe√ßalho com bot√£o extra
        let html = `
            <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                <button class="btn-mini" onclick="window.app.unifyAllColors()" style="padding:5px 15px">
                    <i class="fas fa-paint-roller"></i> Tirar Gradientes (Todas S√≥lidas)
                </button>
            </div>
        `;

        html += (this.data.routes||[]).map((r, i) => `
            <div class="admin-route-row" id="row-${i}">
                <input value="${r.name}" id="r-name-${i}" placeholder="Nome da Rota" style="font-weight:bold">
                
                <input type="color" value="${r.c1}" id="r-c1-${i}" 
                       oninput="window.app.updatePreview(${i})">
                
                <button class="btn-mini" title="Copiar Cor 1 para Cor 2" onclick="window.app.copyColorRow(${i})">
                    <i class="fas fa-arrow-right"></i>
                </button>

                <input type="color" value="${r.c2}" id="r-c2-${i}" 
                       oninput="window.app.updatePreview(${i})">

                <input value="${r.s}" id="r-s-${i}" type="time" step="1">
                <input value="${r.e}" id="r-e-${i}" type="time" step="1">
                
                <button class="btn btn-danger" onclick="window.app.removeRoute(${i})" style="padding:5px"><i class="fas fa-trash"></i></button>
                
                <div id="preview-${i}" class="route-preview" 
                     style="background: linear-gradient(90deg, ${r.c1}, ${r.c2})"></div>
            </div>
        `).join('');

        div.innerHTML = html;
    },

    // Atualiza a barrinha colorida em tempo real
    updatePreview: function(i) {
        const c1 = document.getElementById(`r-c1-${i}`).value;
        const c2 = document.getElementById(`r-c2-${i}`).value;
        document.getElementById(`preview-${i}`).style.background = `linear-gradient(90deg, ${c1}, ${c2})`;
    },

    // Copia C1 para C2 na linha espec√≠fica
    copyColorRow: function(i) {
        const c1 = document.getElementById(`r-c1-${i}`).value;
        document.getElementById(`r-c2-${i}`).value = c1;
        this.updatePreview(i); // Atualiza visual
    },

    // Deixa TODAS as rotas com cor s√≥lida (C2 vira igual C1)
    unifyAllColors: function() {
        if(!confirm("Isso vai remover o gradiente de todas as rotas (copiando a Cor 1 para a Cor 2). Continuar?")) return;
        
        // Aplica na tela
        this.data.routes.forEach((_, i) => {
            const c1 = document.getElementById(`r-c1-${i}`).value;
            document.getElementById(`r-c2-${i}`).value = c1;
            this.updatePreview(i);
        });
    },
    
    addRouteRow: function() { if(!this.data.routes) this.data.routes=[]; this.data.routes.push({name:"Nova",c1:"#000",c2:"#fff",s:"00:00:00",e:"00:00:00"}); this.renderAdminRoutes(); },
    removeRoute: function(i) { if(confirm("Apagar?")){this.data.routes.splice(i,1); this.save();} },
    // --- SALVAR COM VALIDA√á√ÉO DE HOR√ÅRIO ---
    saveRoutesAdmin: function() {
        // 1. Captura os valores da tela para a mem√≥ria
        const tempRoutes = this.data.routes.map((_, i) => ({
            name: document.getElementById(`r-name-${i}`).value,
            c1: document.getElementById(`r-c1-${i}`).value,
            c2: document.getElementById(`r-c2-${i}`).value,
            s: document.getElementById(`r-s-${i}`).value,
            e: document.getElementById(`r-e-${i}`).value
        }));

        // 2. Ordena por hor√°rio de in√≠cio para checar sequ√™ncia
        tempRoutes.sort((a, b) => a.s.localeCompare(b.s));

        // 3. Valida√ß√£o de "Buracos"
        let error = null;
        for (let i = 0; i < tempRoutes.length - 1; i++) {
            const currentEnd = tempRoutes[i].e; // Fim da atual (ex: 10:00:00)
            const nextStart = tempRoutes[i+1].s; // In√≠cio da pr√≥xima
            
            // Aceita diferen√ßa de at√© 1 segundo
            const tEnd = this.hms(currentEnd);
            const tStart = this.hms(nextStart);

            if (Math.abs(tStart - tEnd) > 1) { 
                error = `ERRO DE HOR√ÅRIO:\nA rota "${tempRoutes[i].name}" termina √†s ${currentEnd}, mas a pr√≥xima rota "${tempRoutes[i+1].name}" s√≥ come√ßa √†s ${nextStart}.\n\nCorrija o intervalo!`;
                break;
            }
        }

        if (error) {
            alert(error); // Trava o salvamento
            return; 
        }

        // 4. Se passou, salva no Firebase
        this.data.routes = tempRoutes;
        this.save();
        alert("Rotas validadas e salvas com sucesso!");
        this.renderAdminRoutes(); // Redesenha para garantir a ordem visual
    },

    // --- CRM ---
    populateClientSelect: function() {
        const s = document.getElementById('crm-select');
        s.innerHTML = '<option value="">-- Selecione --</option>' + (this.data.clients||[]).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    },
    loadClientCRM: function() {
        const id = document.getElementById('crm-select').value;
        const div = document.getElementById('crm-content');
        if(!id) { div.style.display='none'; return; }
        div.style.display='block';
        const c = this.data.clients.find(x=>x.id===id);
        document.getElementById('crm-name').innerText = c.name;
        document.getElementById('crm-route').innerText = "ROTA "+c.route;
        
        // KPIs
        const sales = (this.data.salesHistory||[]).filter(s=>s.cli===c.name);
        const fat = sales.reduce((a,b)=>a+b.val,0);
        document.getElementById('kpi-fat').innerText = "R$ "+fat.toFixed(2);
        document.getElementById('kpi-ticket').innerText = "R$ "+(sales.length?fat/sales.length:0).toFixed(2);
        
        // Chart
        const ctx = document.getElementById('salesChart');
        if(window.myChart) window.myChart.destroy();
        const d={}; sales.forEach(s=>d[s.prod]=(d[s.prod]||0)+s.val);
        window.myChart = new Chart(ctx, {type:'bar', data:{labels:Object.keys(d), datasets:[{label:'Vendas',data:Object.values(d),backgroundColor:'#38bdf8'}]}});
        
        // Visits
        document.getElementById('visit-history').innerHTML = (c.visits||[]).map(v=>`<div style="border-bottom:1px solid #eee; padding:5px"><small>${v.date}</small><br>${v.note}</div>`).join('');
    },
    addVisit: function() {
        const id = document.getElementById('crm-select').value;
        const note = document.getElementById('visit-note').value;
        const c = this.data.clients.find(x=>x.id===id);
        if(!c.visits) c.visits=[];
        c.visits.unshift({date:new Date().toLocaleDateString(), note});
        this.save(); document.getElementById('visit-note').value=""; this.loadClientCRM();
    },

    // --- EXPEDI√á√ÉO ---
    handleTagInput: function(e) { 
        if(e.key==='Enter'||e.key===','){ e.preventDefault(); 
            const v=e.target.value.trim().toUpperCase(); 
            if(v && !this.data.tags.includes(v)) {
                this.data.tags.push(v); this.renderTags();
                const o = (this.data.orders||[]).find(o=>o.id===v);
                if(o){ o.sel=true; this.save(); }
            }
            e.target.value=""; 
        }
    },
    renderTags: function() {
        const area = document.getElementById('tag-area');
        area.innerHTML = (this.data.tags||[]).map(t=>`<div class="tag-chip">${t} <span onclick="window.app.removeTag('${t}')" style="cursor:pointer;margin-left:5px">√ó</span></div>`).join('');
    },
    removeTag: function(t) { this.data.tags=this.data.tags.filter(x=>x!==t); this.renderTags(); },
    printLote: function() { alert("Imprimindo: "+this.data.tags.join(", ")); },
    filterExped: function(f, btn) { 
        this.data.filter=f; 
        document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); 
        this.renderExped(); 
    },
    renderExped: function() {
        const l = document.getElementById('exped-list');
        const f = (this.data.orders||[]).filter(o => this.data.filter==='TODOS' || (o.route||'').includes(this.data.filter));
        l.innerHTML = f.map(o=>`<div class="exp-card"><div class="exp-strip" style="background:${this.getRouteColor(o.route)}"></div><div class="exp-content"><div><b>${o.cli}</b><br><small>${o.route} - ${o.id}</small></div><div class="exp-timer" data-time="${o.time}">...</div></div></div>`).join('');
        this.updateTimers();
    },
    getRouteColor: function(r) { return (r||'').includes('AMARELO')?'#fbbf24':(r||'').includes('CORAL')?'#ff7f50':(r||'').includes('BEGE')?'#fcd34d':'#ccc'; },
    updateTimers: function() {
        document.querySelectorAll('.exp-timer').forEach(el=>{
            const d=Date.now()-parseInt(el.getAttribute('data-time'));
            const h=Math.floor(d/3600000), m=Math.floor((d%3600000)/60000);
            el.innerText=`${h}h ${m}m`;
            if(d>7200000) el.style.color='red';
        });
    },

    // --- REQUISI√á√ïES & ATENDIMENTO & PERDAS ---
    addReq: function() {
        const s=document.getElementById('req-sector').value, t=document.getElementById('req-type').value, d=document.getElementById('req-desc').value;
        if(!d)return;
        if(!this.data.reqs) this.data.reqs=[];
        this.data.reqs.push({id:Date.now(), s, t, d}); this.save(); this.renderReqs(); document.getElementById('req-desc').value="";
    },
    renderReqs: function() { document.getElementById('req-list').innerHTML = (this.data.reqs||[]).map(r=>`<div class="card" style="padding:10px"><b>${r.t}</b> (${r.s})<br>${r.d}</div>`).join(''); },
    
    searchCli: function(v) { const c = this.data.clients.find(x=>x.name.toLowerCase().includes(v.toLowerCase())); document.getElementById('at-match').innerText=c?c.name:""; },
    addOrder: function() {
        const name = document.getElementById('at-match').innerText || "Anonimo";
        const c = this.data.clients.find(x=>x.name===name);
        const type = document.getElementById('at-type').value;
        if(!this.data.orders) this.data.orders=[];
        this.data.orders.push({id:"P"+Date.now().toString().slice(-4), cli:name, route:c?c.route:'BALCAO', type, time:Date.now()});
        this.save(); alert("Enviado para Expedi√ß√£o!");
    },
    
    addLoss: function() {
        const i=document.getElementById('loss-item').value, v=parseFloat(document.getElementById('loss-val').value);
        if(!i||!v)return;
        if(!this.data.losses) this.data.losses=[];
        this.data.losses.push({item:i, val:v}); this.save(); this.renderLosses();
    },
    renderLosses: function() {
        const t = (this.data.losses||[]).reduce((a,b)=>a+b.val,0);
        document.getElementById('loss-total').innerText = "R$ "+t.toFixed(2);
        document.getElementById('loss-history').innerHTML = (this.data.losses||[]).slice(-5).map(l=>`<li>${l.item}: R$${l.val}</li>`).join('');
    },

    // --- UTIL ---
    importCSV: function(type, input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const rows = e.target.result.split('\n');
            if(type==='clients') this.data.clients = rows.map(r=>{ const[id,n,rt]=r.split(','); return id?{id:id.trim(),name:n.trim(),route:rt?rt.trim():'GERAL',visits:[]}:null; }).filter(x=>x);
            if(type==='sales') this.data.salesHistory = rows.map(r=>{ const[p,v,c]=r.split(','); return p?{prod:p.trim(),val:parseFloat(v),cli:c?c.trim():'Anonimo'}:null; }).filter(x=>x);
            this.save(); alert("Importado!");
        }
        reader.readAsText(file);
    },
    hms: s => { const p=s.split(':').map(Number); return (p[0]*3600)+(p[1]*60)+(p[2]||0); },

    // --- MONITOR ---
    monitorLoop: function() {
        const now = new Date();
        const sec = (now.getHours()*3600) + (now.getMinutes()*60) + now.getSeconds();
        const listEl = document.getElementById('monitor-schedule-list');
        if(listEl && listEl.innerHTML === '') listEl.innerHTML = (this.data.routes||[]).map(r => `<div style="margin-bottom:5px; color:#fff"><span style="color:${r.c1}">‚óè</span> ${r.name} - ${r.e.substring(0,5)}</div>`).join('');

        const active = (this.data.routes||[]).find(r => {
            const s = this.hms(r.s), e = this.hms(r.e);
            return s > e ? (sec >= s || sec <= e) : (sec >= s && sec <= e);
        });

        if(active && document.getElementById('monitor-rota')) {
            document.getElementById('monitor-bg').style.background = `linear-gradient(135deg, ${active.c1}, ${active.c2})`;
            document.getElementById('monitor-rota').innerText = active.name;
            const e = this.hms(active.e); let t = new Date(); t.setHours(Math.floor(e/3600), Math.floor((e%3600)/60), e%60, 0);
            if(t < now) t.setDate(t.getDate()+1);
            const diff = t - now;
            const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
            const timer = document.getElementById('monitor-timer');
            timer.innerText = `${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
            if(diff < 900000) timer.classList.add('timer-blink-red'); else timer.classList.remove('timer-blink-red');
        }
    }
};

window.app = app;
app.init();
</script>
</body>
</html>

