<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabLog v9.1 - Mobile</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0f172a; --secondary: #334155; --accent: #38bdf8;
            --bg: #f8fafc; --card-bg: #ffffff;
            --success: #22c55e; --danger: #ef4444; --warning: #f59e0b;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); height: 100vh; display: flex; overflow: hidden; color: #1e293b; }
        
        /* SIDEBAR (Barra Lateral) */
        aside { 
            width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; 
            transition: 0.3s; z-index: 100; height: 100%;
        }
        
        /* MAIN CONTENT */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; transition: 0.3s; }
        
        header { 
            background: #fff; padding: 15px; border-bottom: 1px solid #e2e8f0; 
            display: flex; justify-content: space-between; align-items: center; 
            height: 60px; box-sizing: border-box;
        }

        /* MENU HAMBÃšRGUER (SÃ³ aparece no mobile) */
        #mobile-btn { display: none; background: none; border: none; font-size: 1.5rem; color: var(--primary); cursor: pointer; }

        .brand { padding: 30px; font-size: 1.5rem; font-weight: 800; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand span { color: var(--accent); }
        nav { padding: 20px 10px; flex: 1; overflow-y: auto; }
        
        nav button { 
            width: 100%; padding: 14px; margin-bottom: 8px; background: transparent; border: none; 
            color: #94a3b8; text-align: left; cursor: pointer; border-radius: 8px; font-weight: 600; 
            display: flex; align-items: center; gap: 12px; transition: 0.2s; 
        }
        nav button:hover, nav button.active { background: var(--accent); color: #0f172a; }

        /* VIEWS */
        .view { display: none; padding: 20px; overflow-y: auto; height: 100%; box-sizing: border-box; padding-bottom: 80px; }
        .view.active { display: block; }

        /* CARDS & GRID */
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #000; }

        /* MONITOR (TELÃƒO) */
        #v-monitor { padding: 0 !important; background: #000; color: #fff; }
        .monitor-layout { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .monitor-side-panel { 
            position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); 
            padding: 15px; border-radius: 10px; backdrop-filter: blur(5px); text-align: left;
        }
        .timer-big { font-size: 8vw; font-family: monospace; font-weight: 900; background: rgba(0,0,0,0.5); padding: 10px 30px; border-radius: 15px; border: 2px solid #fff; margin-top: 10px; }
        .timer-blink-red { animation: blink 1s infinite; background: #ef4444 !important; border-color: #ef4444 !important; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* ADMIN - Lista de Rotas */
        .admin-route-row { display: grid; grid-template-columns: 2fr 0.5fr 0.5fr 1fr 1fr 0.5fr; gap: 10px; align-items: center; padding: 10px; background: #f8fafc; border: 1px solid #eee; margin-bottom: 5px; border-radius: 8px; }

        /* --- MODO MOBILE (Responsivo) --- */
        @media (max-width: 768px) {
            /* Sidebar vira gaveta escondida */
            aside { position: fixed; left: -260px; height: 100%; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
            aside.active { left: 0; }
            #mobile-btn { display: block; } /* BotÃ£o aparece */
            
            /* Ajustes TelÃ£o Mobile */
            #monitor-rota { font-size: 15vw !important; line-height: 1.1; }
            .timer-big { font-size: 18vw; padding: 5px 15px; width: 80%; }
            .monitor-side-panel { position: relative; top: auto; right: auto; width: 90%; margin-bottom: 20px; }
            
            /* Ajustes Admin Mobile (Vira Cards) */
            .admin-route-row { display: flex; flex-direction: column; gap: 5px; align-items: stretch; border-left: 5px solid var(--primary); }
            .admin-route-header { display: none; } /* Esconde cabeÃ§alho da tabela no mobile */
            
            /* Grids viram coluna Ãºnica */
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        /* Login */
        #login-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h1 style="color:var(--primary)">LabLog <span style="color:var(--accent)">9.1</span></h1>
            <p style="color:#64748b">Acesso Mobile</p>
            <select id="user-role">
                <option value="admin">ðŸ‘‘ ADMIN / GERÃŠNCIA</option>
                <option value="vendas">ðŸ’¼ VENDEDOR</option>
                <option value="telao">ðŸ“º MONITOR</option>
                <option value="exped">ðŸ“¦ EXPEDIÃ‡ÃƒO</option>
            </select>
            <button class="btn btn-primary" onclick="window.app.login()">ENTRAR</button>
        </div>
    </div>

    <aside id="sidebar">
        <div class="brand">LAB<span>LOG</span> <button onclick="window.app.toggleMenu()" style="float:right; background:none; border:none; color:#fff; display:none" id="close-menu-btn">Ã—</button></div>
        <nav id="menu-nav"></nav>
        <div style="padding:20px;">
            <button onclick="window.app.logout()" style="background:rgba(255,255,255,0.1); border:none; color:#fff; width:100%; padding:10px; border-radius:6px;">Sair</button>
        </div>
    </aside>

    <main>
        <header id="top-bar">
            <div style="display:flex; align-items:center; gap:15px">
                <button id="mobile-btn" onclick="window.app.toggleMenu()"><i class="fas fa-bars"></i></button>
                <h3 id="page-title" style="margin:0">Dashboard</h3>
            </div>
            <div style="font-size:0.8rem; color:#64748b"><i class="far fa-user-circle"></i> <span id="user-display">User</span></div>
        </header>

        <div id="v-monitor" class="view">
            <div id="monitor-bg" class="monitor-layout">
                <div class="monitor-side-panel">
                    <h4 style="margin:0 0 10px 0; color:#fff; border-bottom:1px solid #fff;">PRÃ“XIMAS ROTAS</h4>
                    <div id="monitor-schedule-list"></div>
                </div>
                <div style="font-size: 1rem; opacity: 0.8; margin-top:20px">ROTA ATUAL</div>
                <div id="monitor-rota" style="font-size: 6vw; font-weight: 900; text-transform: uppercase;">---</div>
                <div id="monitor-timer" class="timer-big">00:00:00</div>
                <div style="margin-top: 30px; background: rgba(0,0,0,0.4); padding: 10px 20px; border-radius: 50px;">
                    <i class="fas fa-comment-alt" style="color:var(--accent)"></i> <span id="monitor-feed">Carregando...</span>
                </div>
            </div>
        </div>

        <div id="v-admin" class="view">
            <div class="card">
                <h3>ConfiguraÃ§Ã£o de Rotas</h3>
                <div class="admin-route-row admin-route-header">
                    <div>Nome</div><div>Cor 1</div><div>Cor 2</div><div>InÃ­cio</div><div>Fim</div><div>Del</div>
                </div>
                <div id="admin-routes-list"></div>
                <button class="btn btn-success" onclick="window.app.addRouteRow()">+ Rota</button>
                <button class="btn btn-primary" onclick="window.app.saveRoutesAdmin()">Salvar</button>
            </div>
            <div class="card">
                <h3>Importar CSV</h3>
                <div class="upload-zone" onclick="document.getElementById('file-cli').click()" style="padding:20px; border:2px dashed #ccc; text-align:center">
                    <i class="fas fa-users"></i> Importar Clientes
                    <input type="file" id="file-cli" hidden onchange="window.app.importCSV('clients', this)">
                </div>
            </div>
        </div>

        <div id="v-vendas" class="view">
            <div class="card">
                <label>Cliente:</label>
                <select id="crm-select" onchange="window.app.loadClientCRM()" style="width:100%; padding:10px; font-size:1.1rem">
                    <option value="">-- Selecione --</option>
                </select>
            </div>

            <div id="crm-content" style="display:none">
                <div class="card">
                    <h2 id="crm-name">Cliente</h2>
                    <span id="crm-route" style="background:#333; color:#fff; padding:3px 8px; border-radius:5px; font-size:0.8rem">ROTA</span>
                    <div class="grid-2" style="margin-top:10px">
                        <div class="kpi-mini"><b>Faturamento:</b> <span id="kpi-fat">R$ 0</span></div>
                        <div class="kpi-mini"><b>Ticket MÃ©dio:</b> <span id="kpi-ticket">R$ 0</span></div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Registrar Visita</h3>
                    <textarea id="visit-note" rows="3" placeholder="O que foi conversado?"></textarea>
                    <button class="btn btn-success" onclick="window.app.addVisit()">Salvar Visita</button>
                    <div id="visit-history" style="margin-top:15px; max-height:200px; overflow-y:auto"></div>
                </div>
            </div>
        </div>

        <div id="v-exped" class="view">
            <div class="card">
                <h3>Montagem de Lote</h3>
                <input type="text" id="exp-input" placeholder="Bipe o ID aqui..." onkeydown="window.app.handleTagInput(event)">
                <div id="tag-area" class="tag-container" style="margin-top:10px"></div>
            </div>
            <h3>Pendentes</h3>
            <div id="exped-list"></div>
        </div>

    </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBwfvoHhg4mv-XJ7408z90GOtoIv2VjCq0",
  authDomain: "lablog-pro.firebaseapp.com",
  projectId: "lablog-pro",
  storageBucket: "lablog-pro.firebasestorage.app",
  messagingSenderId: "449442181804",
  appId: "1:449442181804:web:195ecea2b9941afb7aa509",
  measurementId: "G-6Q52LZ2NXP"
};

const firebaseApp = initializeApp(firebaseConfig);
const db = getFirestore(firebaseApp);
const auth = getAuth(firebaseApp);

const app = {
    data: { clients: [], salesHistory: [], routes: [], orders: [] },

    init: function() {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('user-display').innerText = user.email.split('@')[0];
                const savedRole = localStorage.getItem('userRole') || 'admin';
                this.renderMenu(savedRole);
                this.startRealtimeSync();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
            }
        });
        setInterval(() => this.monitorLoop(), 1000);
    },

    toggleMenu: function() {
        document.getElementById('sidebar').classList.toggle('active');
    },

    login: async function() {
        const role = document.getElementById('user-role').value;
        const email = prompt("Email:");
        const pass = prompt("Senha:");
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            localStorage.setItem('userRole', role);
            this.renderMenu(role);
            this.nav(role === 'telao' ? 'monitor' : 'admin');
        } catch (e) { alert("Erro: " + e.message); }
    },

    logout: () => signOut(auth).then(()=>location.reload()),

    renderMenu: function(role) {
        const m = document.getElementById('menu-nav');
        let h = `<button onclick="window.app.nav('monitor')"><i class="fas fa-tv"></i> TelÃ£o</button>`;
        if(role==='admin' || role==='vendas') h += `<button onclick="window.app.nav('vendas')"><i class="fas fa-briefcase"></i> Vendas</button>`;
        if(role==='admin') h += `<button onclick="window.app.nav('admin')"><i class="fas fa-cogs"></i> Admin</button>`;
        if(role==='admin' || role==='exped') h += `<button onclick="window.app.nav('exped')"><i class="fas fa-barcode"></i> ExpediÃ§Ã£o</button>`;
        m.innerHTML = h;
    },

    nav: function(v) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.getElementById('v-'+v).classList.add('active');
        document.getElementById('sidebar').classList.remove('active'); // Fecha menu no mobile ao clicar
        document.getElementById('page-title').innerText = v.toUpperCase();
        if(v==='vendas') this.populateClientSelect();
        if(v==='admin') this.renderAdminRoutes();
    },

    startRealtimeSync: function() {
        onSnapshot(doc(db, "config", "laboratorio"), (snap) => {
            if(snap.exists()) {
                this.data = { ...this.data, ...snap.data() };
                this.refreshCurrentView();
            } else {
                this.save(); // Cria se nÃ£o existir
            }
        });
    },

    save: async function() { await setDoc(doc(db, "config", "laboratorio"), this.data); },

    refreshCurrentView: function() {
        const active = document.querySelector('.view.active');
        if(active) {
            const id = active.id.replace('v-','');
            if(id==='admin') this.renderAdminRoutes();
            if(id==='vendas') { /* Recarregar KPIs se necessÃ¡rio */ }
        }
    },

    // --- FUNÃ‡Ã•ES MONITOR ---
    monitorLoop: function() {
        const now = new Date();
        const sec = (now.getHours()*3600) + (now.getMinutes()*60) + now.getSeconds();
        const listEl = document.getElementById('monitor-schedule-list');
        
        // Renderiza lista lateral se vazia
        if(listEl && listEl.innerHTML === '') {
            listEl.innerHTML = (this.data.routes||[]).map(r => `<div style="display:flex; gap:10px; margin-bottom:5px; color:#fff"><div style="width:10px;height:10px;border-radius:50%;background:${r.c1}"></div> ${r.name} - ${r.e.substring(0,5)}</div>`).join('');
        }

        const active = (this.data.routes||[]).find(r => {
            const s = this.hms(r.s), e = this.hms(r.e);
            return s > e ? (sec >= s || sec <= e) : (sec >= s && sec <= e);
        });

        if(active && document.getElementById('monitor-rota')) {
            document.getElementById('monitor-bg').style.background = `linear-gradient(135deg, ${active.c1}, ${active.c2})`;
            document.getElementById('monitor-rota').innerText = active.name;
            const e = this.hms(active.e); let t = new Date(); t.setHours(Math.floor(e/3600), Math.floor((e%3600)/60), e%60, 0);
            if(t < now) t.setDate(t.getDate()+1);
            const diff = t - now;
            const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
            const timer = document.getElementById('monitor-timer');
            timer.innerText = `${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
            if(diff < 900000) timer.classList.add('timer-blink-red'); else timer.classList.remove('timer-blink-red');
        }
    },

    // --- ADMIN ROTAS ---
    renderAdminRoutes: function() {
        const div = document.getElementById('admin-routes-list');
        if(!div) return;
        div.innerHTML = (this.data.routes||[]).map((r, i) => `
            <div class="admin-route-row">
                <input value="${r.name}" id="r-name-${i}" placeholder="Nome">
                <input type="color" value="${r.c1}" id="r-c1-${i}">
                <input type="color" value="${r.c2}" id="r-c2-${i}">
                <input value="${r.s}" id="r-s-${i}" type="time" step="1">
                <input value="${r.e}" id="r-e-${i}" type="time" step="1">
                <button class="btn btn-danger" onclick="window.app.removeRoute(${i})">Del</button>
            </div>
        `).join('');
    },
    addRouteRow: function() { if(!this.data.routes) this.data.routes=[]; this.data.routes.push({name:"Nova",c1:"#000",c2:"#fff",s:"00:00:00",e:"00:00:00"}); this.renderAdminRoutes(); },
    removeRoute: function(i) { if(confirm("Apagar?")){this.data.routes.splice(i,1); this.save();} },
    saveRoutesAdmin: function() {
        this.data.routes.forEach((r, i) => {
            r.name = document.getElementById(`r-name-${i}`).value;
            r.c1 = document.getElementById(`r-c1-${i}`).value;
            r.c2 = document.getElementById(`r-c2-${i}`).value;
            r.s = document.getElementById(`r-s-${i}`).value;
            r.e = document.getElementById(`r-e-${i}`).value;
        });
        this.save(); alert("Salvo!");
    },

    // --- CRM ---
    populateClientSelect: function() {
        const s = document.getElementById('crm-select');
        s.innerHTML = '<option value="">-- Selecione --</option>' + (this.data.clients||[]).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    },
    loadClientCRM: function() {
        const id = document.getElementById('crm-select').value;
        const div = document.getElementById('crm-content');
        if(!id) { div.style.display='none'; return; }
        div.style.display='block';
        const c = this.data.clients.find(x=>x.id===id);
        document.getElementById('crm-name').innerText = c.name;
        // HistÃ³rico
        const hist = document.getElementById('visit-history');
        hist.innerHTML = (c.visits||[]).map(v=>`<div style="border-bottom:1px solid #eee; padding:5px"><small>${v.date}</small><br>${v.note}</div>`).join('');
    },
    addVisit: function() {
        const id = document.getElementById('crm-select').value;
        const note = document.getElementById('visit-note').value;
        const c = this.data.clients.find(x=>x.id===id);
        if(!c.visits) c.visits=[];
        c.visits.unshift({date:new Date().toLocaleDateString(), note});
        this.save(); document.getElementById('visit-note').value=""; this.loadClientCRM();
    },

    // --- UTIL ---
    importCSV: function(type, input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const rows = e.target.result.split('\n');
            if(type==='clients') {
                this.data.clients = rows.map(r=>{ const[id,n]=r.split(','); return id?{id:id.trim(),name:n.trim(),visits:[]}:null; }).filter(x=>x);
            }
            this.save(); alert("Importado!");
        }
        reader.readAsText(file);
    },
    hms: s => { const p=s.split(':').map(Number); return (p[0]*3600)+(p[1]*60)+(p[2]||0); }
};

window.app = app;
app.init();
</script>
</body>
</html>